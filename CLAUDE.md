# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## important-rules

### é‡è¦è§„åˆ™ï¼Œæ¯æ¬¡æ‰§è¡Œä»»åŠ¡å‰éƒ½éœ€è¦ä¸¥æ ¼éµå®ˆä¸‹é¢çš„è§„åˆ™

- æ¯æ¬¡æ‰§è¡Œä»»åŠ¡å‰ï¼Œéƒ½è¦è¾“å‡º`melody, claudeå¼€å§‹æ‰§è¡Œä»»åŠ¡äº†`ï¼Œæ‰§è¡Œä»»åŠ¡å‰éœ€è¦é˜…è¯»`docs/tasks`
- ä¸è¦è¯•å›¾ä¸€æ¬¡æ€§è§£å†³æ‰€æœ‰é—®é¢˜ï¼Œä¸€æ­¥æ­¥æ¨è¿›
- æ¯æ¬¡å®ç°ä¸€ä¸ªæ–°çš„featureï¼Œéƒ½éœ€è¦æ–°å»ºå•å…ƒæµ‹è¯•
- å•å…ƒæµ‹è¯•é€šè¿‡ä»¥åï¼Œæ‰èƒ½æ‰§è¡Œ`git commit`å‘½ä»¤
- æ¯æ¬¡æäº¤ä¸€ä¸ªæ–°çš„`git commit`ï¼Œéƒ½éœ€è¦åœ¨`docs/milestone`ä¸‹è®°å½•é‡Œç¨‹ç¢‘

## Project Overview

æœ¬é¡¹ç›®æ˜¯ä¸€ä¸ª**çº¯ç²¹çš„ç³»ç»Ÿå®¹å™¨**ã€‚

| ç»´åº¦           | è¯´æ˜                                                         |
| -------------- | ------------------------------------------------------------ |
| **æ ¸å¿ƒèŒè´£**   | è´Ÿè´£æ“ä½œç³»ç»Ÿå±‚é¢çš„äº¤äº’ï¼ˆå¯åŠ¨ã€ä¿æ´»ã€å…¨å±ã€ç³»ç»Ÿçƒ­é”®å±è”½ã€å…³æœº/é‡å¯ã€æ›´æ–°ç®¡ç†ï¼‰ |
| **ä¸šåŠ¡è¾¹ç•Œ**   | **ä¸¥ç¦åŒ…å«ä»»ä½•åŒ»ç–—ä¸šåŠ¡é€»è¾‘**ã€‚å®ƒä¸è´Ÿè´£æŒ‚å·ã€ä¹Ÿä¸è´Ÿè´£è¿æ¥ç¡¬ä»¶ï¼ˆç¡¬ä»¶ç”±å¤–éƒ¨ WebSocket æœåŠ¡è´Ÿè´£ï¼‰ |
| **è¿è¡Œæœºåˆ¶**   | å¯åŠ¨åï¼ŒåŠ è½½æœ¬åœ°æŒ‡å®šçš„é™æ€èµ„æºç›®å½•ï¼ˆæ¥è‡ª Project B æ„å»ºåçš„ `dist`ï¼‰ |
| **è·¨å¹³å°æ”¯æŒ** | æ”¯æŒ Windowsï¼ˆç”Ÿäº§éƒ¨ç½²ï¼‰å’Œ macOSï¼ˆå¼€å‘è°ƒè¯•ï¼‰                 |

## é¡¹ç›®ç»“æ„

é‡‡ç”¨ **Monorepo + æ¨¡å—åŒ–** è®¾è®¡ï¼Œå°†æ ¸å¿ƒèƒ½åŠ›æŠ½ç¦»ä¸ºç‹¬ç«‹æ¨¡å—ï¼ˆpackagesï¼‰ï¼Œä¾¿äºå¤ç”¨å’Œæ‰©å±•ã€‚

```text
kiosk-shell/
â”œâ”€â”€ packages/                          # ğŸ“¦ æ ¸å¿ƒèƒ½åŠ›æ¨¡å—ï¼ˆå¯ä½œä¸º submodule ç®¡ç†ï¼‰
â”‚   â”œâ”€â”€ core/                          # å£³æ ¸å¿ƒæ¨¡å—
â”‚   â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”‚   â”œâ”€â”€ window.ts              # çª—å£ç®¡ç†
â”‚   â”‚   â”‚   â”œâ”€â”€ loader.ts              # èµ„æºåŠ è½½
â”‚   â”‚   â”‚   â”œâ”€â”€ protocol.ts            # ğŸ†• è‡ªå®šä¹‰åè®®æ³¨å†Œ (kiosk://)
â”‚   â”‚   â”‚   â”œâ”€â”€ lifecycle.ts           # åº”ç”¨ç”Ÿå‘½å‘¨æœŸ
â”‚   â”‚   â”‚   â””â”€â”€ index.ts
â”‚   â”‚   â”œâ”€â”€ package.json
â”‚   â”‚   â””â”€â”€ tsconfig.json
â”‚   â”‚
â”‚   â”œâ”€â”€ updater/                       # æ›´æ–°æ¨¡å—
â”‚   â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”‚   â”œâ”€â”€ shell-updater.ts       # å£³è‡ªèº«æ›´æ–°
â”‚   â”‚   â”‚   â”œâ”€â”€ business-updater.ts    # ä¸šåŠ¡çƒ­æ›´æ–° (ğŸ†• A/B åŒç¼“å†²æœºåˆ¶)
â”‚   â”‚   â”‚   â”œâ”€â”€ rollback.ts            # å›æ»šé€»è¾‘
â”‚   â”‚   â”‚   â””â”€â”€ index.ts
â”‚   â”‚   â”œâ”€â”€ package.json
â”‚   â”‚   â””â”€â”€ tsconfig.json
â”‚   â”‚
â”‚   â”œâ”€â”€ security/                      # å®‰å…¨æ¨¡å—
â”‚   â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”‚   â”œâ”€â”€ shortcuts.ts           # å¿«æ·é”®å±è”½
â”‚   â”‚   â”‚   â”œâ”€â”€ kiosk-mode.ts          # Kiosk æ¨¡å¼ç®¡ç†
â”‚   â”‚   â”‚   â”œâ”€â”€ ipc-guard.ts           # ğŸ†• IPC æƒé™æ ¡éªŒå’Œé¢‘ç‡é™åˆ¶
â”‚   â”‚   â”‚   â””â”€â”€ index.ts
â”‚   â”‚   â”œâ”€â”€ package.json
â”‚   â”‚   â””â”€â”€ tsconfig.json
â”‚   â”‚
â”‚   â”œâ”€â”€ recovery/                      # å´©æºƒæ¢å¤æ¨¡å—
â”‚   â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”‚   â”œâ”€â”€ crash-handler.ts       # å´©æºƒå¤„ç†
â”‚   â”‚   â”‚   â”œâ”€â”€ blank-detector.ts      # ç™½å±æ£€æµ‹
â”‚   â”‚   â”‚   â”œâ”€â”€ auto-retry.ts          # è‡ªåŠ¨é‡è¯•
â”‚   â”‚   â”‚   â””â”€â”€ index.ts
â”‚   â”‚   â”œâ”€â”€ package.json
â”‚   â”‚   â””â”€â”€ tsconfig.json
â”‚   â”‚
â”‚   â”œâ”€â”€ logger/                        # æ—¥å¿—æ¨¡å—
â”‚   â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”‚   â”œâ”€â”€ file-transport.ts      # æ–‡ä»¶æ—¥å¿— (ğŸ†• å·²é…ç½®æ—¥å¿—è½®è½¬)
â”‚   â”‚   â”‚   â”œâ”€â”€ remote-transport.ts    # è¿œç¨‹ä¸ŠæŠ¥
â”‚   â”‚   â”‚   â””â”€â”€ index.ts
â”‚   â”‚   â”œâ”€â”€ package.json
â”‚   â”‚   â””â”€â”€ tsconfig.json
â”‚   â”‚
â”‚   â”œâ”€â”€ device/                        # ğŸ†• è®¾å¤‡æ ‡è¯†æ¨¡å—
â”‚   â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”‚   â”œâ”€â”€ uuid-manager.ts        # UUID æŒä¹…åŒ–ç®¡ç†
â”‚   â”‚   â”‚   â”œâ”€â”€ hardware-info.ts       # ç¡¬ä»¶ä¿¡æ¯æ”¶é›†
â”‚   â”‚   â”‚   â””â”€â”€ index.ts
â”‚   â”‚   â”œâ”€â”€ package.json
â”‚   â”‚   â””â”€â”€ tsconfig.json
â”‚   â”‚
â”‚   â”œâ”€â”€ watchdog/                      # ğŸ†• çœ‹é—¨ç‹—æ¨¡å—ï¼ˆWindows ä¸“ç”¨ï¼‰
â”‚   â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”‚   â”œâ”€â”€ monitor.ts             # è¿›ç¨‹ç›‘æ§
â”‚   â”‚   â”‚   â”œâ”€â”€ heartbeat.ts           # å¿ƒè·³æ£€æµ‹
â”‚   â”‚   â”‚   â””â”€â”€ index.ts
â”‚   â”‚   â”œâ”€â”€ native/                    # åŸç”Ÿçœ‹é—¨ç‹—å®ç°
â”‚   â”‚   â”‚   â””â”€â”€ watchdog.exe           # C#/Rust ç¼–è¯‘çš„ç‹¬ç«‹å®ˆæŠ¤è¿›ç¨‹
â”‚   â”‚   â”œâ”€â”€ package.json
â”‚   â”‚   â””â”€â”€ tsconfig.json
â”‚   â”‚
â”‚   â”œâ”€â”€ ipc/                           # IPC é€šä¿¡æ¨¡å—
â”‚   â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”‚   â”œâ”€â”€ handlers/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ system.ts          # ç³»ç»Ÿæ§åˆ¶ï¼ˆå…³æœº/é‡å¯ï¼‰
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ device.ts          # è®¾å¤‡ä¿¡æ¯
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ update.ts          # æ›´æ–°ç›¸å…³
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ debug.ts           # è°ƒè¯•åŠŸèƒ½
â”‚   â”‚   â”‚   â”œâ”€â”€ preload.ts             # Preload è„šæœ¬
â”‚   â”‚   â”‚   â””â”€â”€ index.ts
â”‚   â”‚   â”œâ”€â”€ package.json
â”‚   â”‚   â””â”€â”€ tsconfig.json
â”‚   â”‚
â”‚   â””â”€â”€ platform/                      # å¹³å°é€‚é…æ¨¡å— â­
â”‚       â”œâ”€â”€ src/
â”‚       â”‚   â”œâ”€â”€ windows/
â”‚       â”‚   â”‚   â”œâ”€â”€ shortcuts.ts       # Windows å¿«æ·é”®
â”‚       â”‚   â”‚   â”œâ”€â”€ system.ts          # Windows ç³»ç»Ÿæ“ä½œ
â”‚       â”‚   â”‚   â””â”€â”€ index.ts
â”‚       â”‚   â”œâ”€â”€ darwin/
â”‚       â”‚   â”‚   â”œâ”€â”€ shortcuts.ts       # macOS å¿«æ·é”®
â”‚       â”‚   â”‚   â”œâ”€â”€ system.ts          # macOS ç³»ç»Ÿæ“ä½œ
â”‚       â”‚   â”‚   â””â”€â”€ index.ts
â”‚       â”‚   â”œâ”€â”€ adapter.ts             # å¹³å°é€‚é…å™¨
â”‚       â”‚   â””â”€â”€ index.ts
â”‚       â”œâ”€â”€ package.json
â”‚       â””â”€â”€ tsconfig.json
â”‚
â”œâ”€â”€ apps/                              # ğŸ“± åº”ç”¨å…¥å£
â”‚   â””â”€â”€ kiosk/                         # è‡ªåŠ©æœºåº”ç”¨
â”‚       â”œâ”€â”€ src/
â”‚       â”‚   â”œâ”€â”€ main/
â”‚       â”‚   â”‚   â””â”€â”€ index.ts           # ä¸»è¿›ç¨‹å…¥å£
â”‚       â”‚   â””â”€â”€ preload/
â”‚       â”‚       â””â”€â”€ index.ts           # Preload å…¥å£
â”‚       â”œâ”€â”€ resources/                 # å†…ç½®ä¸šåŠ¡èµ„æº
â”‚       â”‚   â””â”€â”€ renderer/
â”‚       â”œâ”€â”€ build/                     # æ‰“åŒ…èµ„æº
â”‚       â”‚   â”œâ”€â”€ icon.ico               # Windows å›¾æ ‡
â”‚       â”‚   â”œâ”€â”€ icon.icns              # macOS å›¾æ ‡
â”‚       â”‚   â””â”€â”€ icon.png               # é€šç”¨å›¾æ ‡
â”‚       â”œâ”€â”€ electron-builder.yml
â”‚       â”œâ”€â”€ package.json
â”‚       â””â”€â”€ tsconfig.json
â”‚
â”œâ”€â”€ shared/                            # ğŸ”— å…±äº«ç±»å‹å’Œå·¥å…·
â”‚   â””â”€â”€ types/
â”‚       â”œâ”€â”€ shell-api.d.ts             # ShellAPI ç±»å‹å®šä¹‰
â”‚       â”œâ”€â”€ update.d.ts                # æ›´æ–°ç›¸å…³ç±»å‹
â”‚       â””â”€â”€ index.ts
â”‚
â”œâ”€â”€ scripts/                           # ğŸ›  æ„å»ºè„šæœ¬
â”‚   â”œâ”€â”€ build.ts                       # ç»Ÿä¸€æ„å»ºè„šæœ¬
â”‚   â”œâ”€â”€ dev.ts                         # å¼€å‘å¯åŠ¨è„šæœ¬
â”‚   â””â”€â”€ release.ts                     # å‘å¸ƒè„šæœ¬
â”‚
â”œâ”€â”€ package.json                       # Root package.json (workspaces)
â”œâ”€â”€ pnpm-workspace.yaml                # pnpm workspace é…ç½®
â”œâ”€â”€ tsconfig.base.json                 # åŸºç¡€ TypeScript é…ç½®
â””â”€â”€ README.md
```


## Development Commands

```bash
# Install dependencies
pnpm install

# Run the Electron app (once main entry point is created)
pnpm exec electron .
```

## Tech Stack

| æ¨¡å—         | é€‰å‹                         | è¯´æ˜                                         |
| ------------ | ---------------------------- | -------------------------------------------- |
| **Core**     | **Electron** (Latest Stable) | å®¿ä¸»ç¯å¢ƒ,è·¨å¹³å°æ”¯æŒ                         |
| **Language** | **TypeScript**               | ç”¨äºç¼–å†™ Main Process è„šæœ¬,å¯ç”¨ä¸¥æ ¼æ¨¡å¼     |
| **Builder**  | **electron-builder**         | è´Ÿè´£æ‰“åŒ…ä¸º `.exe` (Windows) / `.dmg` (macOS) |
| **Update**   | **electron-updater**         | è´Ÿè´£å£³è‡ªèº«çš„ç‰ˆæœ¬æ›´æ–°                         |
| **Log**      | **electron-log**             | ç³»ç»Ÿçº§æ—¥å¿—(è®°å½•å´©æºƒã€å¯åŠ¨å¤±è´¥ã€ç™½å±)ï¼Œ**å·²é…ç½®æ—¥å¿—è½®è½¬** |
| **Plugin**   | **electron-localshortcut**   | ç”¨äºå±è”½/æ³¨å†Œå¿«æ·é”®                          |
| **Download** | **electron-dl**              | ä¸šåŠ¡èµ„æºåŒ…ä¸‹è½½                               |
| **Zip**      | **adm-zip**                  | èµ„æºåŒ…è§£å‹                                   |
| **Protocol** | **Custom Protocol**          | `kiosk://` åè®®ï¼Œæ›¿ä»£ `file://` è§£å†³è·¯å¾„å’Œ CORS é—®é¢˜ |
| **Watchdog** | **ç‹¬ç«‹çœ‹é—¨ç‹—è¿›ç¨‹**           | Windows ç¯å¢ƒä¸‹çš„è¿›ç¨‹ä¿æ´»å®ˆæŠ¤ï¼ˆå¯é€‰ï¼šC#/Rust/Node.jsï¼‰ |

### æ¨¡å—èŒè´£è¯´æ˜

| æ¨¡å—              | èŒè´£                             | å¯ç‹¬ç«‹ä½¿ç”¨ | å®¡è®¡æ”¹è¿› |
| ----------------- | -------------------------------- | ---------- | -------- |
| `@kiosk/core`     | çª—å£åˆ›å»ºã€èµ„æºåŠ è½½ã€ç”Ÿå‘½å‘¨æœŸç®¡ç†ã€**è‡ªå®šä¹‰åè®®** | âœ… | ğŸ†• åè®®ä¼˜åŒ– |
| `@kiosk/updater`  | å£³æ›´æ–°ã€ä¸šåŠ¡çƒ­æ›´æ–°ã€å›æ»šã€**A/BåŒç¼“å†²** | âœ… | ğŸ†• åŸå­æ€§æ›´æ–° |
| `@kiosk/security` | å¿«æ·é”®å±è”½ã€Kiosk æ¨¡å¼ã€**IPCæƒé™æ§åˆ¶** | âœ… | ğŸ†• æƒé™å¢å¼º |
| `@kiosk/recovery` | å´©æºƒå¤„ç†ã€ç™½å±æ£€æµ‹ã€è‡ªåŠ¨æ¢å¤     | âœ… |  |
| `@kiosk/logger`   | æ—¥å¿—è®°å½•ã€è¿œç¨‹ä¸ŠæŠ¥ã€**æ—¥å¿—è½®è½¬** | âœ… | ğŸ†• è½®è½¬ç­–ç•¥ |
| `@kiosk/ipc`      | IPC å¤„ç†å™¨ã€Preload è„šæœ¬         | âœ… |  |
| `@kiosk/platform` | è·¨å¹³å°é€‚é…ï¼ˆWindows/macOSï¼‰      | âœ… |  |
| `@kiosk/device`   | **è®¾å¤‡å”¯ä¸€æ ‡è¯†UUIDç®¡ç†**         | âœ… | ğŸ†• æ–°å¢æ¨¡å— |
| `@kiosk/watchdog` | **è¿›ç¨‹ä¿æ´»å®ˆæŠ¤ï¼ˆWindowsä¸“ç”¨ï¼‰**   | âœ… | ğŸ†• æ–°å¢æ¨¡å— |

### Workspace é…ç½®

```yaml
# pnpm-workspace.yaml
packages:
  - 'packages/*'
  - 'apps/*'
  - 'shared/*'
// package.json (root)
{
  "name": "kiosk-shell-monorepo",
  "private": true,
  "scripts": {
    "dev": "pnpm --filter @kiosk/app dev",
    "build": "pnpm -r build",
    "build:win": "pnpm --filter @kiosk/app build:win",
    "build:mac": "pnpm --filter @kiosk/app build:mac"
  },
  "devDependencies": {
    "typescript": "^5.3.0",
    "electron": "^28.0.0",
    "electron-builder": "^24.0.0"
  }
}
```

### æ¨¡å—é—´ä¾èµ–ç¤ºä¾‹

```json
// apps/kiosk/package.json
{
  "name": "@kiosk/app",
  "dependencies": {
    "@kiosk/core": "workspace:*",
    "@kiosk/updater": "workspace:*",
    "@kiosk/security": "workspace:*",
    "@kiosk/recovery": "workspace:*",
    "@kiosk/logger": "workspace:*",
    "@kiosk/ipc": "workspace:*",
    "@kiosk/platform": "workspace:*"
  }
}
```
## å¼€å‘è§„èŒƒ

### ç¦æ­¢äº‹é¡¹ (DO NOT)

- âŒ ç¦æ­¢åœ¨å£³é¡¹ç›®ä¸­å¼•å…¥ä»»ä½•åŒ»ç–—ä¸šåŠ¡ç›¸å…³çš„ npm åŒ…
- âŒ ç¦æ­¢åœ¨ Main Process ä¸­å¤„ç†æ‚£è€…æ•°æ®
- âŒ ç¦æ­¢å…³é—­ `contextIsolation` æˆ–å¼€å¯ `nodeIntegration`
- âŒ ç¦æ­¢è·³è¿‡ hash æ ¡éªŒç›´æ¥è§£å‹æ›´æ–°åŒ…
- âŒ ç¦æ­¢åˆ é™¤å¤‡ä»½ç›®å½•ï¼ˆä¿ç•™è‡³å°‘ä¸€ä¸ªç‰ˆæœ¬ç”¨äºå›æ»šï¼‰
- âŒ ç¦æ­¢åœ¨ä»£ç ä¸­ç¡¬ç¼–ç æ›´æ–°æœåŠ¡å™¨åœ°å€ï¼ˆèµ°é…ç½®æ–‡ä»¶ï¼‰
- âŒ ç¦æ­¢ä½¿ç”¨ `any` ç±»å‹ï¼ˆTypeScript ä¸¥æ ¼æ¨¡å¼ï¼‰
- âŒ ç¦æ­¢åœ¨ packages ä¸­ç›´æ¥å¼•ç”¨ apps çš„ä»£ç 

### å¿…é¡»äº‹é¡¹ (MUST DO)

- âœ… æ‰€æœ‰ IPC é€šä¿¡å¿…é¡»é€šè¿‡ `contextBridge` æš´éœ²
- âœ… æ‰€æœ‰ç³»ç»Ÿæ“ä½œå¿…é¡»æœ‰æ—¥å¿—è®°å½•
- âœ… æ›´æ–°å‰å¿…é¡»å¤‡ä»½å½“å‰ç‰ˆæœ¬
- âœ… å´©æºƒåå¿…é¡»æœ‰è‡ªåŠ¨æ¢å¤æœºåˆ¶
- âœ… è¿ç»´å…¥å£å¿…é¡»æœ‰å¯†ç ä¿æŠ¤
- âœ… å¹³å°ç›¸å…³ä»£ç å¿…é¡»æ”¾åœ¨ `@kiosk/platform` æ¨¡å—
- âœ… æ–°åŠŸèƒ½å¿…é¡»è€ƒè™‘ Windows/macOS å…¼å®¹æ€§
